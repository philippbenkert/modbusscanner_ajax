<div class="container-fluid mt-5 full-height">
    <h1 class="text-center">Dateimanager</h1>
    
    <div class="mt-5">
        <div class="card-header bg-primary text-white">
            Dateien
        </div>
        <ul class="list-group list-group-flush" id="file-list"></ul>
    </div>

    <div class="mt-5">
        <div class="card-header bg-primary text-white">
            Datei hochladen
        </div>
        <div class="card-body">
            <input type="file" id="upload-file" class="form-control mb-3">
            <button onclick="uploadFile()" class="btn btn-primary">
                📤 Upload
            </button>
        </div>
    </div>
</div>

<script>

let currentPath = '/'; // speichert den aktuellen Pfad

function createListItem(content, className = 'list-group-item d-flex justify-content-between align-items-center') {
    const li = document.createElement('li');
    li.className = className;
    li.innerHTML = content;
    return li;
}

async function fetchFiles(path = '/') {
    console.log("fetchFiles() aufgerufen.");
    currentPath = path;

    try {
        const files = await httpRequest(`/list-dir?path=${path}`);
        console.log("Empfangene Dateien:", files);
        
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';
        
        if (path !== '/') {
            const backItem = createListItem(`🔙 <a href="#" onclick="fetchFiles('/')">Zurück zum Hauptordner</a>`);
            fileList.appendChild(backItem);
        }
        
        const sortedFiles = files.sort((a, b) => {
            if (a.type === 'directory' && b.type !== 'directory') return -1;
            if (a.type !== 'directory' && b.type === 'directory') return 1;
            return a.name.localeCompare(b.name);
        });

        sortedFiles.forEach(file => {
            let content;
            if (file.type === 'directory') {
                content = `<span>📁 <a href="#" onclick="fetchFiles('${path}${file.name}/')">${file.name}</a></span>`;
            } else {
                content = `
                    📄 ${file.name}
                    <div class="d-flex align-items-center">
                        <span class="badge badge-primary badge-pill">${file.size} bytes</span>
                        <a href="/download?path=${path}${file.name}" target="_blank" class="btn btn-sm btn-success ml-3">Download</a>
                    </div>
                `;
            }
            fileList.appendChild(createListItem(content));
        });
        
    } catch (error) {
        console.error("Fehler beim Abrufen der Dateiliste:", error);
    }
}

function uploadFile() {
    console.log("uploadFile() aufgerufen.");
    const fileInput = document.getElementById('upload-file');
    const file = fileInput.files[0];
    if (!file) {
        console.warn("Keine Datei zum Hochladen ausgewählt.");
        return;
    }
    const formData = new FormData();
    formData.append('file', file);
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Status: ${response.status}, Text: ${response.statusText}`);
        }
        console.log("Datei erfolgreich hochgeladen.");
        alert('Datei hochgeladen!');
        fetchFiles();
    })
    .catch(error => {
        console.error("Fehler beim Hochladen der Datei:", error);
    });
}

document.addEventListener('click', function(event) {
    if (event.target.closest('a') && event.target.closest('li')) {
        const path = event.target.getAttribute('data-path');
        if (path) {
            fetchFiles(path);
            event.preventDefault();
        }
    }
});
</script>
